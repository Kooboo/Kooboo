var A=(f,a,n)=>new Promise((r,e)=>{var u=i=>{try{m(n.next(i))}catch(w){e(w)}},g=i=>{try{m(n.throw(i))}catch(w){e(w)}},m=i=>i.done?r(i.value):Promise.resolve(i.value).then(u,g);m((n=n.apply(f,a)).next())});import{d as q,o as d,a as P,b,w as p,F as I,b6 as U,aH as G,t as F,f as $,g as h,ce as J,j as C,u as S,k as B,i as O,cd as Z,c as ee,x as H,cj as te,b7 as oe,e as ae}from"./url.8f5ec20c.js";import{u as Q}from"./replace-all.dd6016f2.js";import{_ as le}from"./index.026f772c.js";import{_ as se,c as ne}from"./index.8143a7f0.js";import{_ as re}from"./index.b3d1cf25.js";import{g as j}from"./i18n.2d8b30eb.js";import{E as ie,a as ue}from"./index.0a83bb10.js";import{P as me}from"./settings.4ce13064.js";import{a as ce,g as de}from"./index.44c0c248.js";import{_ as pe}from"./index.ed88cf90.js";import{E as fe}from"./index.4c9af567.js";import{E as ve}from"./index.a4ff385c.js";import{l as W,p as _e,a as X}from"./page.c26fc024.js";import{t as ge,m as ye}from"./layout-model.8e92a20f.js";import{c as he}from"./index.ab4ed870.js";import{E as be}from"./windi.bf752d69.js";import{E as Y}from"./index.96970839.js";import{E as xe,a as we,b as Ee}from"./index.35ae15db.js";import{E as ke,a as Ce}from"./index.c57e2953.js";import{_ as Se}from"./index.47274d5a.js";import{u as Ve,E as $e}from"./main.d8c6ef59.js";import{c as Ne,e as Ae,n as Pe}from"./style.ad574a57.js";import{e as z}from"./guid.c1a40312.js";import{u as Ie}from"./use-save-tip.ee41ca28.js";import{r as Te,a as De,i as Re}from"./validate.348f94d6.js";import{a as Be,s as Le,N as Ue,K as Fe,L as qe}from"./dev-mode.e5eea554.js";import{E as je}from"./index.bb5499e2.js";import{E as Me,a as He}from"./index.a141884f.js";import{E as ze}from"./index.593106e3.js";import"./classCompletion.a22e38a6.js";import"./userWorker.b3a6730b.js";import"./editor.main.d2800f63.js";import"./preload-helper.13a99eb0.js";import"./vuedraggable.umd.8a5464a3.js";import"./index.ec785feb.js";import"./focus-trap.3f074800.js";import"./isNil.98bb3b88.js";import"./event.53b2ad83.js";import"./index.a595fe6d.js";import"./cloneDeep.b77ba92c.js";import"./_baseClone.29a8cd97.js";import"./_baseIsEqual.2f38f7c3.js";import"./event.776e7e11.js";import"./error.7e8331f1.js";import"./basic.99ce9c67.js";import"./index.745dc8e0.js";import"./validator.1bcd6e6a.js";import"./index.21d7e739.js";import"./index.0535d5fe.js";import"./index.e3f90979.js";import"./plugin-vue_export-helper.21dcd24c.js";import"./index.bf8ed8c6.js";import"./scroll.54c27fbd.js";import"./refs.d2253dd4.js";import"./index.80a4dc1a.js";import"./aria.75ec5909.js";import"./isEqual.c3e9e9f4.js";import"./debounce.730e1961.js";import"./toNumber.6efebd6a.js";import"./index.b68af8a1.js";import"./dropdown.d7a15792.js";import"./index.c70f33ac.js";import"./index.50c16ae5.js";import"./confirm.617d359f.js";import"./logo-transparent.1566007e.js";import"./index.37979027.js";import"./index.3dc39d21.js";import"./index.832f2769.js";import"./index.b3e4ff8e.js";import"./index.5af167df.js";import"./config.589cc0cd.js";import"./dark.7c26a0d3.js";import"./use-copy-text.67d6617b.js";import"./index.68d24a68.js";import"./toggleComment.5b29ca87.js";import"./icon-button.e30c79ea.js";import"./index.e87fdc52.js";import"./index.3be79fd5.js";import"./index.5f2a659f.js";import"./index.06224119.js";import"./index.14aabd47.js";import"./alert.8fe5500a.js";import"./index.b4ac73b5.js";/* empty css                                                               */import"./media-list.vue_vue_type_style_index_0_scoped_true_lang.a31db113.js";/* empty css                                                          */import"./file.52d8e05a.js";import"./use-date.28e9a8a3.js";import"./dayjs.min.35b12e7a.js";/* empty css                                                          *//* empty css                                                                 */import"./use-file-upload.1cd07d1f.js";/* empty css                                                         */import"./image-editor.vue_vue_type_style_index_0_scoped_true_lang.7c6ede25.js";import"./image-editor.404a4df5.js";import"./main.esm.f3ac04a5.js";import"./index.a330b59f.js";var L=(f=>(f[f.design=0]="design",f[f.settings=1]="settings",f))(L||{});const Oe={class:"flex items-center px-24 py-12 leading-none"},Ge=$("p",{class:"flex-1 text-m"},null,-1),Ke=q({props:{modelValue:null},emits:["update:modelValue"],setup(f){const{t:a}=j(),n=[{key:L.design,value:a("common.design")},{key:L.settings,value:a("common.setting")}];return(r,e)=>{const u=ie,g=ue;return d(),P("div",Oe,[b(g,{class:"el-radio-group--rounded","model-value":f.modelValue,"onUpdate:modelValue":e[0]||(e[0]=m=>r.$emit("update:modelValue",m))},{default:p(()=>[(d(),P(I,null,U(n,m=>b(u,{key:m.key,label:m.key,"data-cy":m.key===0?"design":"setting"},{default:p(()=>[G(F(m.value),1)]),_:2},1032,["label","data-cy"])),64))]),_:1},8,["model-value"]),Ge,b(re)])}}}),Qe={class:"p-32 grid grid-cols-3"},Xe=["title"],Je=q({props:{modelValue:{type:Boolean},model:null,sources:null},emits:["update:modelValue","selected"],setup(f,{emit:a}){const n=f;j();const r=h(!0),e=h([]),u=h([]),g=()=>A(this,null,function*(){e.value=yield ce(n.model.tagName)}),m=J(()=>{const s=[];for(const l of e.value){const y=n.sources.find(t=>t.id===l.name);(y==null?void 0:y.tag)!=="layout"&&s.push(l)}return s}),i=(s,l)=>{l?u.value.push(s):u.value=u.value.filter(y=>y!==s)},w=()=>A(this,null,function*(){r.value=!1,a("selected",u.value)});return g(),(s,l)=>{const y=fe,t=ve;return d(),C(t,{"model-value":r.value,"custom-class":"el-dialog--zero-padding",width:"600px","close-on-click-modal":!1,title:f.model.displayName,onClosed:l[1]||(l[1]=o=>a("update:modelValue",!1))},{footer:p(()=>[b(pe,{disabled:!u.value.length,onConfirm:w,onCancel:l[0]||(l[0]=o=>r.value=!1)},null,8,["disabled"])]),default:p(()=>[$("div",null,[$("div",Qe,[(d(!0),P(I,null,U(S(m),o=>(d(),C(y,{key:o.id,size:"large",onChange:v=>i(o,v)},{default:p(()=>[$("p",{class:"hover:text-blue w-140px ellipsis text-16px h-17px",title:o.name,"data-cy":"name"},F(o.name),9,Xe)]),_:2},1032,["onChange"]))),128))])])]),_:1},8,["model-value","title"])}}}),We=q({props:{model:null,sources:null},setup(f){const a=f,{t:n}=j(),r=h([]),e=h(),u=h();de().then(t=>r.value=t);function g(t,o){if(o.type==="layout"){t.push(o);for(const v of o.content)for(const V of v.addons)g(t,V);return t}}const m=J(()=>{const t=[];return g(t,a.model),t}),i=t=>A(this,null,function*(){var v,V,T;for(const _ of t){const c={id:_.name,type:e.value.tagName.toLowerCase(),attributes:{id:_.name}},E=yield ge(a.sources,c);if((v=e.value)!=null&&v.requireEngine&&(c.attributes.engine=e.value.engineName),(V=e.value)!=null&&V.attribute){var o=document.createElement("div");o.innerHTML=`<div ${(T=e.value)==null?void 0:T.attribute} />`,o=o.children.item(0);for(const D of o.getAttributeNames())c.attributes[D]=o.getAttribute(D)}c.type==="layout"&&(c.content=W(c.id,E.source.body).content),u.value.addons.push(c)}}),w=(t,o)=>{o.addons=o.addons.filter(v=>v!==t),a.sources.splice(a.sources.findIndex(v=>v.id===t.id&&v.tag===t.type),1)},s=(t,o)=>{const v=o.addons.splice(t.oldIndex,1)[0];o.addons.splice(t.newIndex,0,v)},l=h(!1),y=(t,o)=>{e.value=t,u.value=o,l.value=!0};return(t,o)=>{const v=he,V=be,T=Y,_=xe,c=we,E=Ee,D=ke,M=Ce;return d(),P(I,null,[(d(!0),P(I,null,U(S(m),N=>(d(),C(M,{key:N.id,"model-value":N.content.map(k=>k.name)},{default:p(()=>[(d(!0),P(I,null,U(N.content,k=>(d(),C(D,{key:k.name,name:k.name,title:N==f.model?S(n)("common.positionName",{name:k.name}):S(n)("common.positionNameAndFrom",{name:k.name,from:N.id})},{default:p(()=>[b(se,{list:k.addons,"id-prop":"id","display-prop":"id",onDelete:(x,R)=>w(R,k),onSort:x=>s(x,k)},{right:p(({item:x})=>[b(v,{size:"small",class:"rounded-full mr-8","data-cy":"content-tag"},{default:p(()=>[G(F(x.type),1)]),_:2},1024)]),bottom:p(()=>[b(E,{trigger:"click",onCommand:x=>y(x,k)},{dropdown:p(()=>[b(c,null,{default:p(()=>[(d(!0),P(I,null,U(r.value,x=>(d(),C(_,{key:x.tagName,command:x,"data-cy":x.tagName},{default:p(()=>[$("span",null,F(x.displayName),1)]),_:2},1032,["command","data-cy"]))),128))]),_:1})]),default:p(()=>[b(T,{circle:""},{default:p(()=>[b(V,{class:"text-blue iconfont icon-a-addto","data-cy":"add"})]),_:1})]),_:2},1032,["onCommand"])]),_:2},1032,["list","onDelete","onSort"])]),_:2},1032,["name","title"]))),128))]),_:2},1032,["model-value"]))),128)),l.value?(d(),C(Je,{key:0,modelValue:l.value,"onUpdate:modelValue":o[0]||(o[0]=N=>l.value=N),model:e.value,sources:f.sources,onSelected:i},null,8,["modelValue","model","sources"])):B("",!0)],64)}}}),Ye=q({props:{page:null,design:null,sources:null},setup(f){const a=f,n=Ve(),r=h(""),e=(u,g)=>{const m=a.sources.find(s=>s.tag===u.type&&s.id===u.id);if(!m)return"";if(u.type!=="layout")return m.source.body;let i=Ne(m.source.body);if(g){if(a.page.styles)for(const s of a.page.styles){const l=i.createElement("link");l.rel="stylesheet",l.href=s,i.head.appendChild(l)}if(a.page.scripts)for(const s of a.page.scripts){const l=i.createElement("script");l.src=s,i.head.appendChild(l)}}const w=u.content;for(const s of Ae(i)){const l=s.getAttribute("k-placeholder"),y=w.find(t=>t.name===l);y&&y.addons&&(s.innerHTML=y.addons.map(t=>e(t,!1)).join(""))}return Pe(i)};return O([()=>a.sources,()=>a.design,()=>a.page],()=>{r.value=e(a.design,!0)},{deep:!0,immediate:!0}),(u,g)=>(d(),C(Se,{content:r.value,"base-url":S(n).site.prUrl},null,8,["content","base-url"]))}}),Ze={key:0,class:"flex w-full h-full"},et={class:"flex-1 pr-32 pl-80px flex flex-col min-h-400px min-w-600px"},tt={class:"pt-16 flex items-center"},ot={class:"flex-1 rounded-normal overflow-hidden shadow-s-10 mb-100px bg-fff min-h-400px"},at={class:"bg-card dark:bg-[#333] shadow-s-10 w-400px h-full"},lt={class:"pb-150px"},Jo=q({setup(f){const{t:a}=j(),n=h(),r=h(),e=h(),u=Be(),g=h([]),m=Z(),i=h(L.design),w=h(),s=Ie(),l=h(),y=h(),t=ee(()=>{var _;return{name:((_=e.value)==null?void 0:_.id)&&e.value.id!==z?[]:[Te(1,50),De(a("common.nameRequiredTips")),Re(Le,a("common.thePageNameAlreadyExists"))]}});A(this,null,function*(){n.value=yield Ue(H("layoutId")),e.value=yield u.getPage(H("id"));const _=W(n.value.name,n.value.body),c=_e(e.value.body);y.value=e.value.urlPath,g.value.push({id:n.value.name,tag:"layout",source:{body:n.value.body}}),yield ye(_,c,g.value),r.value=_,s.init(e.value)});const o=_=>{!e.value||e.value.urlPath||(e.value.urlPath=`/${_}`)},v=()=>{e.value&&(e.value.body=X(r.value)),m.goBackOrTo(Q({name:"pages"}))};te((_,c,E)=>A(this,null,function*(){_.name==="login"?E():yield s.check(e.value).then(()=>{E()}).catch(()=>{E(!1)})}));const V=()=>A(this,null,function*(){var _;!e.value||(yield Promise.all([w.value.validate(),(_=l.value)==null?void 0:_.validate()]).then(()=>A(this,null,function*(){var E;const c=e.value.id===z;yield u.updatePage(e.value),$e.success(a("common.saveSuccess")),y.value=(E=e.value.urlPath)!=null?E:"",s.init(e.value),c&&m.replace(Q({name:"layout-page-setting",query:{id:e.value.id,layoutId:H("layoutId")}}))})))}),T=()=>A(this,null,function*(){yield V(),v()});return Fe().loadAll(),qe().loadAll(),ne("save",V),O(()=>e.value,()=>{s.changed(e.value)},{deep:!0}),O(()=>r.value,()=>{r.value&&(e.value.body=X(r.value)),s.changed(e.value)},{deep:!0}),(_,c)=>{const E=je,D=Me,M=He,N=ze,k=Y,x=oe("hasPermission");return d(),P(I,null,[r.value?(d(),P("div",Ze,[$("div",et,[$("div",tt,[e.value?(d(),C(M,{key:0,ref_key:"form",ref:w,model:e.value,rules:S(t)},{default:p(()=>[b(D,{label:S(a)("common.pageName"),prop:"name"},{default:p(()=>[b(E,{modelValue:e.value.name,"onUpdate:modelValue":c[0]||(c[0]=R=>e.value.name=R),class:"w-300px",title:e.value.name,disabled:e.value.id!==S(z),"data-cy":"page-name",onChange:o,onInput:c[1]||(c[1]=R=>{var K;return e.value.name=(K=e.value)==null?void 0:K.name.replace(/\s+/g,"")})},null,8,["modelValue","title","disabled"])]),_:1},8,["label"])]),_:1},8,["model","rules"])):B("",!0)]),$("div",ot,[e.value&&n.value?(d(),C(Ye,{key:0,design:r.value,page:e.value,sources:g.value},null,8,["design","page","sources"])):B("",!0)])]),$("div",at,[b(N,null,{default:p(()=>[$("div",lt,[b(Ke,{modelValue:i.value,"onUpdate:modelValue":c[2]||(c[2]=R=>i.value=R)},null,8,["modelValue"]),i.value===S(L).design&&r.value?(d(),C(We,{key:0,model:r.value,sources:g.value},null,8,["model","sources"])):B("",!0),i.value===S(L).settings&&e.value&&n.value?(d(),C(me,{key:1,ref_key:"settingsForm",ref:l,model:e.value,"old-url-path":y.value,layout:n.value.body,sources:g.value},null,8,["model","old-url-path","layout","sources"])):B("",!0)])]),_:1})])])):B("",!0),b(le,{back:"",permission:{feature:"pages",action:"edit"},onCancel:v,onSave:V},{"extra-buttons":p(()=>[ae((d(),C(k,{round:"",type:"primary","data-cy":"save-and-return",onClick:T},{default:p(()=>[G(F(S(a)("common.saveAndReturn")),1)]),_:1})),[[x,{feature:"pages",action:"edit"}]])]),_:1})],64)}}});export{Jo as default};
