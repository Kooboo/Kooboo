var _e=Object.defineProperty,Te=Object.defineProperties;var xe=Object.getOwnPropertyDescriptors;var te=Object.getOwnPropertySymbols;var Ve=Object.prototype.hasOwnProperty,Ce=Object.prototype.propertyIsEnumerable;var le=(c,i,m)=>i in c?_e(c,i,{enumerable:!0,configurable:!0,writable:!0,value:m}):c[i]=m,ae=(c,i)=>{for(var m in i||(i={}))Ve.call(i,m)&&le(c,m,i[m]);if(te)for(var m of te(i))Ce.call(i,m)&&le(c,m,i[m]);return c},ne=(c,i)=>Te(c,xe(i));var N=(c,i,m)=>new Promise((y,g)=>{var x=_=>{try{f(m.next(_))}catch(e){g(e)}},l=_=>{try{f(m.throw(_))}catch(e){g(e)}},f=_=>_.done?y(_.value):Promise.resolve(_.value).then(x,l);f((m=m.apply(c,i)).next())});import{_ as ke}from"./icon-button.315b6443.js";import{d as we,g as re,o as ie,w as Ie}from"./i18n.bcd18f8a.js";import{_ as Ne}from"./k-table.7d05e82e.js";import{a as Ue,u as he}from"./index.a32fb6e5.js";import{a as D,l as qe,r as Ee,q as Se}from"./validate.238a9986.js";import{_ as Re}from"./index.7a75fca3.js";import{E as Be}from"./index.0a8d3d17.js";import{c as me}from"./cloneDeep.060340c1.js";import{E as Ke}from"./index.5cbbc5d7.js";import{E as Le,a as De}from"./index.6d63eb53.js";import{E as $e,a as Me}from"./index.6d22f937.js";import{E as de}from"./windi.19264205.js";import{E as ce}from"./index.aec72f69.js";import{E as Pe}from"./index.daafc4da.js";import{E as Ae}from"./index.d4a6b2d5.js";import{d as pe,g as R,L as Fe,c as $,h as fe,i as E,o as v,j as C,w as r,b as u,u as t,a as U,b6 as se,F as S,k as I,f as w,aH as F,t as T,cd as Oe,x as ue,M as ze,J as Je,cj as We,b7 as je,e as Qe,n as Z}from"./url.8f5ec20c.js";import{u as Ye}from"./use-table.ec0182e9.js";import{_ as Ge}from"./index.5f76a3ad.js";import{u as He}from"./replace-all.d441bf14.js";import{u as Xe}from"./main.582f9de6.js";import{u as Ze}from"./use-save-tip.8f44d6c0.js";import{E as eo}from"./index.b83a1079.js";import"./index.ec6ad7db.js";import"./focus-trap.eafcfd1f.js";import"./isNil.98bb3b88.js";import"./event.53b2ad83.js";import"./index.05e21f33.js";import"./index.3a977dfb.js";import"./index.c80f5028.js";import"./sortable.esm.a99254e8.js";import"./index.564bc658.js";import"./isEqual.11d86bcc.js";import"./_baseIsEqual.547729d3.js";import"./error.7e8331f1.js";import"./index.59b1471f.js";import"./event.776e7e11.js";import"./style.9c8f6403.js";import"./toNumber.6efebd6a.js";import"./index.2341329b.js";import"./index.bda83f28.js";import"./index.bff48780.js";import"./index.649f6c77.js";import"./index.e3f90979.js";import"./_baseClone.eeff2792.js";import"./index.79f78425.js";import"./scroll.4888a9e9.js";import"./debounce.730e1961.js";import"./index.9a83ee01.js";import"./validator.b73911a9.js";import"./index.a3d8335f.js";import"./refs.d2253dd4.js";import"./index.50c16ae5.js";import"./preload-helper.13a99eb0.js";import"./confirm.eadb49f1.js";import"./logo-transparent.1566007e.js";import"./index.10f642b2.js";import"./aria.75ec5909.js";const k=we.global.t;function ve(){const c=[{displayName:k("common.textBox"),value:"TextBox",dataType:"String"},{displayName:k("common.textArea"),value:"TextArea",dataType:"String"},{displayName:k("common.WYSIWYGEditor"),value:"Tinymce",dataType:"String"},{displayName:k("common.selection"),value:"Selection",dataType:"Undefined"},{displayName:k("common.checkbox"),value:"CheckBox",dataType:"Undefined"},{displayName:k("common.radiobox"),value:"RadioBox",dataType:"Undefined"},{displayName:k("common.boolean"),value:"Boolean",dataType:"Bool"},{displayName:k("common.dateTime"),value:"DateTime",dataType:"DateTime"},{displayName:k("common.number"),value:"Number",dataType:"Number"}];function i(y){return c.find(x=>{var l;return((l=x.value)==null?void 0:l.toLowerCase())===(y==null?void 0:y.toLowerCase())})}function m(y){return c.filter(x=>x.dataType.toLowerCase()===y.toLowerCase())}return{controlTypes:c,getControlType:i,getAvailableControlTypes:m}}const oo={class:"w-full"},to=pe({props:{modelValue:{type:Boolean},columns:null,column:null,dbType:null},emits:["update:modelValue"],setup(c,{emit:i}){const m=c,y=R(!0),{columns:g}=Fe(m);let x;const{t:l}=re(),f=R(),_=()=>({name:"",dataType:"String",isIncremental:!1,seed:0,scale:1,isIndex:!1,isPrimaryKey:!1,isUnique:!1,controlType:"TextBox",isSystem:!1,length:1024,setting:{options:[]}}),e=R(_()),M=$(()=>!m.column),P=$(()=>{var a;return((a=e.value.controlType)==null?void 0:a.toLowerCase())==="number"}),B=R(!1),W=a=>{a.target.blur(),V()};function h(a,o){if(a!=="dataType")return o}fe(()=>{var a;y.value&&((a=f.value)==null||a.resetFields(),m.column?(e.value=m.column,B.value=P.value&&!e.value.isIncremental,x=JSON.stringify(m.column,h)):(e.value=_(),B.value=!1))});const j={name:[D(l("common.fieldRequiredTips")),qe(),{validator(a,o,n){if(o.trim().toLowerCase()==="_id"){n(l("common.columnIsReservedWord",{columnName:o}));return}n()}},Ee(1,50),Se(M,g)],length:D(l("common.fieldRequiredTips")),seed:D(l("common.fieldRequiredTips")),scale:D(l("common.fieldRequiredTips")),options:[{validator(a,o,n){e.value.setting.options.length===0?n(new Error(l("common.fieldRequiredTips"))):n()},trigger:"blur"}]},{controlTypes:K,getControlType:O,getAvailableControlTypes:Q}=ve(),A=$(()=>m.column?Q(m.column.dataType):K);E(()=>e.value.isPrimaryKey,a=>{a&&(e.value.isUnique=!0)}),E(()=>e.value.isUnique,a=>{a?e.value.isIndex=!0:(e.value.isIncremental||e.value.isPrimaryKey)&&(e.value.isUnique=!0)}),E(()=>e.value.isPrimaryKey,a=>{a&&(e.value.isUnique=!0)}),E(()=>e.value.isIndex,a=>{!a&&e.value.isUnique&&(e.value.isIndex=!0)}),E(()=>e.value.isIncremental,a=>{e.value.isUnique=a,e.value.isIndex=a}),E(()=>e.value.controlType,()=>{var a;e.value.dataType=((a=Y.value)==null?void 0:a.dataType)||"String"});const Y=$(()=>{var a;if(e.value.controlType)return O((a=e.value)==null?void 0:a.controlType)}),b=$(()=>e.value.controlType?["textbox","textarea","tinymce"].includes(e.value.controlType.toLowerCase()):!1),p=$(()=>e.value.controlType?["selection","checkbox","radiobox"].includes(e.value.controlType.toLowerCase()):!1);function q(a){const o=e.value.setting;o.options.splice(o.options.indexOf(a),1)}function L(){var o;e.value.setting.options.push({key:"",value:""}),p.value&&((o=f.value)==null||o.clearValidate("options"))}function V(){return N(this,null,function*(){var a;yield(a=f.value)==null?void 0:a.validate(o=>N(this,null,function*(){if(o){const n=me(e.value);if(!p.value){const d=n.setting||{};d.options=[]}if(P.value||(n.isIncremental=!1),n.isPrimaryKey&&g.value.forEach(d=>d.isPrimaryKey=!1),M.value)g.value.push(n);else if(x!==JSON.stringify(e.value,h)){const d=g.value.findIndex(G=>G.name===n.name);g.value[d]=n}y.value=!1}}))})}return(a,o)=>{const n=Ke,d=Le,G=$e,ye=Me,H=Be,ee=de,oe=ce,z=Pe,be=De,ge=Ae;return v(),C(ge,{"model-value":y.value,width:"600px","close-on-click-modal":!1,title:t(l)("common.columnSettings"),onClosed:o[14]||(o[14]=s=>i("update:modelValue",!1))},{footer:r(()=>[u(Re,{permission:{feature:"database",action:"edit"},onConfirm:V,onCancel:o[13]||(o[13]=s=>y.value=!1)})]),default:r(()=>[u(be,{ref_key:"columnForm",ref:f,model:e.value,rules:j,"label-position":"top",onSubmit:o[12]||(o[12]=Ie(()=>{},["prevent"])),onKeydown:ie(V,["enter"])},{default:r(()=>[t(M)?(v(),C(d,{key:0,prop:"name",label:t(l)("common.name")},{default:r(()=>[u(n,{modelValue:e.value.name,"onUpdate:modelValue":o[0]||(o[0]=s=>e.value.name=s),"data-cy":"column-name"},null,8,["modelValue"])]),_:1},8,["label"])):(v(),C(d,{key:1,label:t(l)("common.name")},{default:r(()=>[u(n,{modelValue:e.value.name,"onUpdate:modelValue":o[1]||(o[1]=s=>e.value.name=s),disabled:"","data-cy":"control-type"},null,8,["modelValue"])]),_:1},8,["label"])),u(d,{label:t(l)("common.controlType")},{default:r(()=>[u(ye,{modelValue:e.value.controlType,"onUpdate:modelValue":o[2]||(o[2]=s=>e.value.controlType=s),class:"w-full",disabled:t(A).length<=1},{default:r(()=>[(v(!0),U(S,null,se(t(A),s=>(v(),C(G,{key:s.value,value:s.value,label:s.displayName,"data-cy":"control-type-opt"},null,8,["value","label"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1},8,["label"]),c.dbType==="Database"?(v(),U(S,{key:2},[t(b)?(v(),C(d,{key:0,prop:"length",label:t(l)("common.length")},{default:r(()=>[u(H,{modelValue:e.value.length,"onUpdate:modelValue":o[3]||(o[3]=s=>e.value.length=s),min:1,precision:0,placeholder:t(l)("common.length"),"data-cy":"length",onKeydown:o[4]||(o[4]=ie(s=>W(s),["enter"]))},null,8,["modelValue","placeholder"])]),_:1},8,["label"])):I("",!0)],64)):I("",!0),t(p)?(v(),C(d,{key:3,prop:"options",label:t(l)("common.options")},{default:r(()=>[(v(!0),U(S,null,se(e.value.setting.options,(s,X)=>(v(),U("div",{key:X,class:"flex items-center space-x-4 mb-16"},[u(d,{prop:"setting.options."+X+".key",rules:t(D)(t(l)("common.fieldRequiredTips"))},{default:r(()=>[u(n,{modelValue:s.key,"onUpdate:modelValue":J=>s.key=J,placeholder:t(l)("common.displayName")},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["prop","rules"]),u(d,{prop:"setting.options."+X+".value",rules:t(D)(t(l)("common.fieldRequiredTips"))},{default:r(()=>[u(n,{modelValue:s.value,"onUpdate:modelValue":J=>s.value=J,placeholder:t(l)("common.value")},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["prop","rules"]),u(oe,{circle:"",onClick:J=>q(s)},{default:r(()=>[u(ee,{class:"iconfont icon-delete text-orange"})]),_:2},1032,["onClick"])]))),128)),w("div",oo,[u(oe,{circle:"",onClick:o[5]||(o[5]=s=>L())},{default:r(()=>[u(ee,{class:"iconfont icon-a-addto text-blue"})]),_:1})])]),_:1},8,["label"])):I("",!0),t(P)&&c.dbType==="Database"?(v(),U(S,{key:4},[u(d,null,{default:r(()=>[u(z,{modelValue:e.value.isIncremental,"onUpdate:modelValue":o[6]||(o[6]=s=>e.value.isIncremental=s),size:"large",disabled:B.value},{default:r(()=>[F(T(t(l)("common.incremental")),1)]),_:1},8,["modelValue","disabled"])]),_:1}),e.value.isIncremental?(v(),C(d,{key:0,prop:"seed",label:t(l)("common.seed")},{default:r(()=>[u(H,{modelValue:e.value.seed,"onUpdate:modelValue":o[7]||(o[7]=s=>e.value.seed=s),min:0,precision:0},null,8,["modelValue"])]),_:1},8,["label"])):I("",!0),e.value.isIncremental?(v(),C(d,{key:1,prop:"scale",label:t(l)("common.scale")},{default:r(()=>[u(H,{modelValue:e.value.scale,"onUpdate:modelValue":o[8]||(o[8]=s=>e.value.scale=s),min:1,precision:0,placeholder:t(l)("common.scale")},null,8,["modelValue","placeholder"])]),_:1},8,["label"])):I("",!0)],64)):I("",!0),u(d,null,{default:r(()=>[c.dbType==="Database"?(v(),U(S,{key:0},[u(z,{modelValue:e.value.isPrimaryKey,"onUpdate:modelValue":o[9]||(o[9]=s=>e.value.isPrimaryKey=s),size:"large","data-cy":"primary-key"},{default:r(()=>[F(T(t(l)("common.primaryKey")),1)]),_:1},8,["modelValue"]),u(z,{modelValue:e.value.isUnique,"onUpdate:modelValue":o[10]||(o[10]=s=>e.value.isUnique=s),size:"large","data-cy":"unique"},{default:r(()=>[F(T(t(l)("common.unique")),1)]),_:1},8,["modelValue"])],64)):I("",!0),u(z,{modelValue:e.value.isIndex,"onUpdate:modelValue":o[11]||(o[11]=s=>e.value.isIndex=s),size:"large","data-cy":"index"},{default:r(()=>[F(T(t(l)("common.index")),1)]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","onKeydown"])]),_:1},8,["model-value","title"])}}}),lo={class:"database-columns p-24 pb-150px"},ao={class:"text-2l mb-12px font-bold dark:text-[#fffa]"},no={class:"flex items-center py-24 space-x-16"},io={"data-cy":"column-name"},so={"data-cy":"control-type"},pt=pe({setup(c){const{t:i}=re(),m=Oe(),y=Xe(),g=ue("table"),x=ue("from"),l=R([]),f=R(void 0),{getControlType:_}=ve(),{dbType:e,appendQueryToRoute:M,getListRouteName:P}=Ye(),B=P(),W=ze(),h=Ze();W.meta.activeMenu=B,fe(()=>N(this,null,function*(){let b=yield Ue(e,{table:g});b=b.filter(p=>p.name!="_version"),l.value=b,h.init(l.value)})),Je(()=>{y.firstActiveMenu=""}),We((b,p,q)=>N(this,null,function*(){var L;b.name==="login"?q():(y.firstActiveMenu=(L=b.meta.activeMenu)!=null?L:b.name,yield h.check(l.value).then(()=>{q()}).catch(()=>{y.firstActiveMenu=p.query.dbType?p.query.dbType.toLocaleLowerCase()+".table":"table",q(!1)}))}));function j(b){return N(this,null,function*(){y.hasAccess("database","edit")&&(l.value=l.value.filter(p=>p!==b))})}const K=R(!1);function O(b){K.value=!0,f.value=b?me(b):void 0,f.value&&(f.value.setting?f.value.setting=typeof f.value.setting=="string"?JSON.parse(f.value.setting):f.value.setting:f.value.setting={options:[]})}function Q(){return N(this,null,function*(){const b=l.value.map(p=>ne(ae({},p),{setting:typeof p.setting=="string"?p.setting:JSON.stringify(p.setting)}));yield he(e,{tableName:g,columns:b}),h.init(l.value),A()})}function A(){x?m.push(M({name:x,query:{table:g}})):m.push(He({name:B}))}function Y(){return N(this,null,function*(){A()})}return E(()=>l.value,()=>{h.changed(l.value)},{deep:!0}),(b,p)=>{const q=de,L=ce,V=eo,a=ke,o=je("hasPermission");return v(),U(S,null,[w("div",lo,[w("div",ao,T(t(i)("common.dataTable"))+": "+T(t(g)),1),w("div",no,[Qe((v(),C(L,{round:"","data-cy":"new-column",onClick:p[0]||(p[0]=n=>O())},{default:r(()=>[u(q,{class:"iconfont icon-a-addto"}),F(" "+T(t(i)("common.newColumn")),1)]),_:1})),[[o,{feature:"database",action:"edit"}]])]),u(t(Ne),{data:l.value},{default:r(()=>[u(V,{label:t(i)("common.columnName")},{default:r(({row:n})=>[w("span",io,T(n.name),1)]),_:1},8,["label"]),u(V,{label:t(i)("common.controlType"),width:"200"},{default:r(({row:n})=>{var d;return[w("span",so,T((d=t(_)(n.controlType))==null?void 0:d.displayName),1)]}),_:1},8,["label"]),t(e)==="Database"?(v(),U(S,{key:0},[u(V,{label:t(i)("common.primaryKey"),width:"150",align:"center"},{default:r(({row:n})=>[w("span",{class:Z(n.isPrimaryKey?"text-green":"text-999"),"data-cy":"primary-key"},T(n.isPrimaryKey?t(i)("common.yes"):t(i)("common.no")),3)]),_:1},8,["label"]),u(V,{label:t(i)("common.unique"),width:"150",align:"center"},{default:r(({row:n})=>[w("span",{class:Z(n.isUnique?"text-green":"text-999"),"data-cy":"unique"},T(n.isUnique?t(i)("common.yes"):t(i)("common.no")),3)]),_:1},8,["label"])],64)):I("",!0),u(V,{label:t(i)("common.index"),width:"150",align:"center"},{default:r(({row:n})=>[w("span",{class:Z(n.isIndex?"text-green":"text-999"),"data-cy":"index"},T(n.isIndex?t(i)("common.yes"):t(i)("common.no")),3)]),_:1},8,["label"]),u(V,{width:"90",align:"center"},{default:r(({row:n})=>[u(a,{icon:"icon-a-writein",tip:t(i)("common.edit"),"data-cy":"edit",onClick:d=>O(n)},null,8,["tip","onClick"]),u(a,{permission:{feature:"database",action:"edit"},class:"text-orange hover:text-orange",icon:"icon-delete",tip:t(i)("common.delete"),"data-cy":"remove",onClick:d=>j(n)},null,8,["tip","onClick"])]),_:1})]),_:1},8,["data"]),u(Ge,{permission:{feature:"database",action:"edit"},onCancel:Y,onSave:Q})]),K.value?(v(),C(to,{key:0,modelValue:K.value,"onUpdate:modelValue":p[1]||(p[1]=n=>K.value=n),columns:l.value,column:f.value,"db-type":t(e)},null,8,["modelValue","columns","column","db-type"])):I("",!0)],64)}}});export{pt as default};
