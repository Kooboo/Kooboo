<!-- #layout name=blank -->
<div id="app">
  <div class="page-header">
    <h1 class="title">Authentication</h1>
  </div>
  <kb-breadcrumb :breads="breads"></kb-breadcrumb>
  <div class="navbar navbar-default">
    <div class="container-fluid">
      <a class="btn green navbar-btn" @click="onCreateOrEdit()">Create</a>
      <a
        class="btn red navbar-btn"
        v-show="selectedRows.length>0"
        @click="onDelete"
        >Delete</a
      >
    </div>
  </div>
  <kb-table :data="model" show-select :selected.sync="selectedRows">
    <kb-table-column :label="Kooboo.text.common.name">
      <template v-slot="row">
        <span @click.stop="">{{ row.name }}</span>
      </template>
    </kb-table-column>

    <kb-table-column :label="Kooboo.text.common.lastModified">
      <template v-slot="row">
        <span> {{ new Date(row.lastModified).toDefaultLangString() }} </span>
      </template>
    </kb-table-column>

    <kb-table-column align="right" width="200px">
      <template v-slot="row">
        <a class="btn blue" @click.stop="onCreateOrEdit(row)"
          >{{ Kooboo.text.common.setting }}</a
        >
      </template>
    </kb-table-column>
  </kb-table>
  <div
    class="modal fade"
    data-backdrop="static"
    data-keyboard="false"
    v-kb-modal="showEditModal"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button class="close" @click="showEditModal=false"
            ><i class="fa fa-close"></i
          ></button>
          <h4 class="modal-title">{{ editModalTitle }}</h4>
        </div>
        <div class="modal-body" v-if="showEditModal&&types">
          <kb-form :model="editModel">
            <kb-form-item prop="name">
              <label class="control-label col-md-3">Name</label>
              <div class="col-md-9">
                <input
                  type="text"
                  class="form-control"
                  v-model="editModel.name"
                  :disabled="!isNew"
                />
              </div>
            </kb-form-item>
            <kb-form-item prop="matcher">
              <label class="control-label col-md-3">Matcher</label>
              <div class="col-md-9">
                <select v-model="editModel.matcher" class="form-control">
                  <option
                    v-for="item in types.matcher"
                    :key="item.name"
                    :value="item.name"
                    >{{ item.display }}</option
                  >
                </select>
              </div>
            </kb-form-item>
            <kb-form-item prop="action">
              <label class="control-label col-md-3">Action</label>
              <div class="col-md-9">
                <select v-model="editModel.succeedAction" class="form-control">
                  <option
                    v-for="item in types.succeedAction"
                    :key="item.name"
                    :value="item.name"
                    >{{ item.display }}</option
                  >
                </select>
              </div>
            </kb-form-item>

            <template v-if="editModel.action=='CustomCode'">
              <kb-form-item>
                <label class="control-label col-md-3"></label>
                <div class="col-md-9">
                  <select
                    v-model="editModel.failedActionDetail"
                    class="form-control"
                  >
                    <option
                      v-for="item in authenticationCodes"
                      :key="item.name"
                      :value="item.name"
                      >{{ item.name }}</option
                    >
                  </select>
                </div>
              </kb-form-item>
            </template>

            <template v-else>
              <kb-form-item prop="failedAction">
                <label class="control-label col-md-3">FailedAction</label>
                <div class="col-md-9">
                  <select v-model="editModel.failedAction" class="form-control">
                    <option
                      v-for="item in types.failedAction"
                      :key="item.name"
                      :value="item.name"
                      >{{ item.display }}</option
                    >
                  </select>
                </div>
              </kb-form-item>
              <kb-form-item
                v-if="editModel.failedAction=='ResultCode'||editModel.failedAction=='Redirect'"
              >
                <label class="control-label col-md-3"></label>
                <div class="col-md-9">
                  <input
                    type="text"
                    class="form-control"
                    v-model="editModel.failedActionDetail"
                  />
                </div>
              </kb-form-item>
            </template>
            
          </kb-form>
        </div>
        <div class="modal-footer">
          <button @click="onSave" class="btn green">Save</button>
          <button @click="showEditModal=false" class="btn gray">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  Kooboo.loadJS([
    "/_Admin/Scripts/components/kbBreadcrumb.js",
    "/_Admin/Scripts/components/kbForm.js",
    "/_Admin/Scripts/components/kbTable.js",
    "/_Admin/Scripts/components/kbRelationModal.js",
    "/_Admin/Scripts/kooboo/Guid.js",
  ]);
  new Vue({
    el: "#app",
    data: function () {
      var me = this;
      return {
        breads: [
          {
            name: "SITES",
          },
          {
            name: "DASHBOARD",
          },
          {
            name: Kooboo.text.common.authentication,
          },
        ],
        model: [],
        types: null,
        selectedRows: [],
        showEditModal: false,
        editModel: null,
        conditions: [],
        authenticationCodes: [],
      };
    },
    mounted: function () {
      var me = this;
      Kooboo.Authentication.getTypes().then(function (res) {
        if (res.success) {
          me.types = res.model;
        }
      });
      me.getList();
    },
    computed: {
      isNew: function () {
        if (!this.editModel) return true;
        return this.editModel.id == Kooboo.Guid.Empty;
      },
      editModalTitle: function () {
        if (this.isNew) {
          return Kooboo.text.common.create + ": ";
        } else {
          return Kooboo.text.common.edit + ": " + this.editModel.name;
        }
      },
    },
    methods: {
      onDelete: function () {
        var me = this;
        var haveRelations = this.selectedRows.some(function (s) {
          return s.relations && Object.keys(s.relations).length;
        });

        var confirmStr = haveRelations
          ? Kooboo.text.confirm.deleteItemsWithRef
          : Kooboo.text.confirm.deleteItems;

        var ids = this.selectedRows.map(function (m) {
          return m.id;
        });

        if (!confirm(confirmStr)) return;

        Kooboo[Kooboo.View.name]
          .Deletes({
            ids: ids,
          })
          .then(function (res) {
            if (res.success) {
              Kooboo.View.getList().then(function (res) {
                me.model = _.sortBy(res.model, [
                  function (r) {
                    return r.lastModified;
                  },
                ]).reverse();
              });
              window.info.done(Kooboo.text.info.delete.success);
            } else {
              window.info.done(Kooboo.text.info.delete.fail);
            }
          });
      },
      onCreateOrEdit: function (row) {
        if (row) {
          this.editModel = row;
        } else {
          this.editModel = {
            id: Kooboo.Guid.Empty,
            name: "",
            matcher: "None",
            action: "None",
            failedAction: "None",
            failedActionDetail: "",
          };
        }
        this.showEditModal = true;
      },
      onSave: function () {
        var me = this;
        Kooboo.Authentication.post(me.editModel).then(function () {
          me.getList();
          me.showEditModal = false;
        });
      },
      getList: function () {
        var me = this;
        Kooboo.Authentication.getList().then(function (res) {
          if (res.success) {
            me.model = res.model;
            me.selectedRows = [];
          }
        });
      },
      onDelete: function () {
        var me = this;
        if (!confirm(Kooboo.text.confirm.deleteItems)) return;

        var ids = this.selectedRows.map(function (m) {
          return m.id;
        });

        Kooboo.Authentication.Deletes({
          ids: ids,
        }).then(function (res) {
          if (res.success) {
            me.getList();
            window.info.done(Kooboo.text.info.delete.success);
          } else {
            window.info.done(Kooboo.text.info.delete.fail);
          }
        });
      },
    },
    watch: {
      "editModel.failedAction": function (value) {
        if (value == "ResultCode") this.editModel.failedActionDetail = "401";
        if (value == "Redirect") this.editModel.failedActionDetail = "/";
        if (value == "CustomCode") {
        }
      },
    },
  });
</script>
